---
- name: Create Internal LDAP Certificates
  include_role:
    name: certificates
  vars:
    namespace: "{{ _amlen_namespace }}"
    cert: "{{ item }} "
    issuerName: "{{ _amlen_namespace}}-internal-issuer"
    duration: 175200h0m0s
    renewBefore: 2160h0m0s
    waitForCert: yes
  loop:
  - name: "{{ _amlen_name }}-ldap-certs"
    usages: [ "client auth", "server auth" ]

- name: Set the ldaps {{ _amlen_state }}
  k8s:
    state: "{{ _amlen_state }}"
    merge_type:
    - strategic-merge
    - merge
    definition: "{{ lookup('template', item ) | from_yaml }}"
  loop:
  - ./templates/ldap.j2
  - ./templates/ldap-service.j2

- name: Wait until ldap is available
  k8s_info:
    kind: StatefulSet
    name: "ldap"
    namespace: "{{ _amlen_namespace }}"
  register: statefulset
  until:
  - statefulset.resources[0].status.readyReplicas is defined
  - statefulset.resources[0].status.readyReplicas == 1
  retries: 10
  delay: 10
  ignore_errors: yes
  loop: "{{ range(0,nodes|int)|list}}"
  loop_control:
    loop_var: id

- name: get certs
  k8s_info:
    kind: Secret
    name: "{{_amlen_name}}-ldap-certs"
    namespace: "{{ _amlen_namespace }}"
  register: certs

- name: deploy LDAP
  include_tasks: configure_ldap.yml
  loop: "{{ range(0,size,1)|list}}"
  loop_control:
    loop_var: pair_id
