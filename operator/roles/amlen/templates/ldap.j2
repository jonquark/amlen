apiVersion: apps/v1
kind: Deployment
metadata:
  name: ldap
  namespace: "{{ _amlen_namespace }}"
  labels:
    app: ldap
spec:
  selector:
    matchLabels:
      app: ldap
  replicas: 1
  template:
    metadata:
      labels:
        app: ldap
    spec:
      containers:
        - name: ldap
          image: bitnami/openldap:latest
          terminationMessagePolicy: "FallbackToLogsOnError"
          volumeMounts:
            - name: ldap-config
              mountPath: /ldifs
            - name: internal-certs
              mountPath: /secrets/internal_certs
          ports:
            - containerPort: {{ LDAP_PORT_NUMNER | default(1389) }}
              name: openldap
          env:
            - name: LSAP_PORT_NUMBER
              value: "{{ LDAP_PORT_NUMNER | default('1389') }}"
            - name: LDAP_ROOT
              value: "{{ LDAP_ROOT | default('dc=amleninternal,dc=auth') }}"
            - name: LDAP_ADMIN_USERNAME
              value: "{{ LDAP_ADMIN_USERNAME | default('admin') }}"
            - name: LDAP_ADMIN_PASSWORD
              value: "{{ LDAP_ADMIN_PASSWORD | default('adminpassword') }}"
            - name: LDAP_LOGLEVEL
              value: "{{ LDAP_LOGLEVEL | default('-1') }}"
            - name: BITNAMI_DEBUG
              value: "{{ BITNAMI_DEBUG | default(true) }}"
            - name: LDAP_BIND_DN
              value: "{{ LDAP_BIND_DN | default('cn=admin,dc=amleninternal,dc=auth') }}"
            - name: LDAP_BIND_PASSWORD
              value: "{{ LDAP_BIND_PASSWORD | default('adminpassword') }}"
            - name: LDAP_CONFIG_ADMIN_ENABLED
              value: "{{ LDAP_CONFIG_ADMIN_ENABLED | default('yes') }}"
            - name: LDAP_CONFIG_ADMIN_USERNAME
              value: "{{ LDAP_CONFIG_ADMIN_USERNAME | default('admin') }}"
            - name: LDAP_CONFIG_ADMIN_PASSWORD
              value: "{{ LDAP_CONFIG_ADMIN_PASSWORD | default('adminpassword') }}"
   
      volumes:
      - name: ldap-config
        configMap:
          name: ldap-config
      - name: internal-certs
        secret:
          secretName: "{{ _amlen_namespace }}-ldap-certs"
